define(["jquery","core/ajax","core/notification","core/str"],function(a,b,c,d){function e(a){return!a&&(d.get_strings([{key:"error"},{key:"pleaseinputtext",component:"block_socialcomments"}]).done(function(a){c.alert(a[0],a[1])}).fail(c.exception),!0)}function f(){a("#ccomment-editform-wrap").append(a("#ccomment-editform")),v(),a("#ccomment-replyform-wrap").append(a("#ccomment-replyform")),s()}function g(d){f(),b.call([{methodname:"block_socialcomments_get_commentspage",args:{contextid:D.contextid,pagenumber:d},done:function(b){I=b.pagenumber,a("#ccomment-commentspage-wrap").html(b.commentspage)},fail:c.exception}],!1)}function h(d,f){var h=d.val(),i=a("#ccomments-groupid").val();e(h)||b.call([{methodname:"block_socialcomments_save_comment",args:{contextid:D.contextid,content:h,groupid:i,id:f},done:function(b){a(".ccomment-comments-count").html(b.count),a("#ccomment-comments-content-top").removeClass("hidden"),d.val(""),0===f?(g(C),a("#ccomment-comments-subscribed").prop("checked",!0)):g(I);var c=a("#ccomment-comment-listitem-"+b.id),e=a(window);c.offset().top>e.scrollTop()+e.height()&&a("html, body").animate({scrollTop:c.offset().top-c.outerHeight()},1e3)},fail:c.exception}],!1)}function i(a,d){var f=a.val();e(f)||b.call([{methodname:"block_socialcomments_save_reply",args:{contextid:D.contextid,content:f,commentid:F,id:d},done:function(){a.val(""),g(I)},fail:c.exception}],!1)}function j(b){f(),d.get_string("commentdeleted","block_socialcomments").done(function(c){a("#ccomment-comment-listitem-"+b.deletedcommentid).addClass("ccomment-highlight"),a("#ccomment-comment-listitem-"+b.deletedcommentid).html(c).fadeOut(2e3,function(){g(I)})}),d.get_string("commentscount","block_socialcomments",b.count).done(function(b){a(".ccomment-comments-count").html(b)}),0!==b.count||D.subscribed||a("#ccomment-comments-content-top").addClass("hidden")}function k(a){b.call([{methodname:"block_socialcomments_delete_comment",args:{commentid:Number(a.attr("id").split("-")[4])},done:j,fail:c.exception}])}function l(b){f(),d.get_string("replydeleted","block_socialcomments").done(function(c){a("#ccomment-reply-"+b.deletedreplyid).addClass("ccomment-highlight"),a("#ccomment-reply-"+b.deletedreplyid).html(c).fadeOut(2e3,function(){g(I)})})}function m(a){b.call([{methodname:"block_socialcomments_delete_reply",args:{replyid:Number(a.attr("id").split("-")[4])},done:l,fail:c.exception}])}function n(a){b.call([{methodname:"block_socialcomments_set_pinned",args:{contextid:D.contextid,checked:a.prop("checked"),commentid:Number(a.attr("id").split("-")[2])},done:function(b){a.prop("checked",b.checked);var c=a.parent().find(".ccomments-pin-tooltip");c.html(b.tooltip)},fail:c.exception}])}function o(a){b.call([{methodname:"block_socialcomments_set_subscribed",args:{contextid:D.contextid,checked:a.prop("checked")},done:function(b){D.subscribed=b.checked,a.prop("checked").prop("checked",D.subscribed)},fail:c.exception}])}function p(b){r(),F=Number(b.attr("id").split("-")[2]),N.attr("data-commentid",F);var c=a("#ccomment-reply-list-"+F);c.before(a("#ccomment-replyform"))}function q(b){r(),G=Number(b.attr("id").split("-")[4]),N.attr("data-replyid",G);var c=a("#ccomment-reply-"+G+" .ccomment-post-content");N.val(c.html()),c.after(a("#ccomment-replyform")),c.hide()}function r(){a("#ccomment-replyform-wrap").append(a("#ccomment-replyform")),a("#ccomment-reply-"+G+" .ccomment-post-content").show(),s()}function s(){G=0,N.attr("data-replyid",0),F=0,N.attr("data-commentid",0),N.val("")}function t(b){u(),E=Number(b.attr("id").split("-")[4]),L.attr("data-commentid",E);var c=a("#ccomment-post-"+E+" .ccomment-post-content");L.val(c.html()),c.after(a("#ccomment-editform")),c.hide()}function u(){a("#ccomment-editform-wrap").append(a("#ccomment-editform")),a("#ccomment-post-"+E+" .ccomment-post-content").show(),v()}function v(){E=0,L.attr("data-commentid",0),L.val("")}function w(a){I=Number(a.attr("id").split("-")[2]),g(I)}function x(b){y(),H=Number(b.attr("id").split("-")[3]),a("#ccomment-comments-content #action-menu-"+H).addClass("show"),a("#ccomment-comments-content #action-menu-"+H).attr("data-enhanced",1)}function y(){H>=0&&(a("#ccomment-comments-content #action-menu-"+H).removeClass("show"),a("#ccomment-comments-content #action-menu-"+H).removeAttr("data-enhanced"),H=-1)}function z(a,b){b?a.addClass("ccomment-highlight-button"):a.removeClass("ccomment-highlight-button")}function A(){J=a("#ccomment-form-textarea"),K=a("#ccomment-form-action-post"),K.click(function(){h(J,0),z(K,J.val())}),J.keyup(function(){z(K,J.val())}),a("#ccomment-form-action-cancel").click(function(){J.val(""),K.removeClass("ccomment-highlight-button")}),L=a("#ccomment-edit-textarea"),M=a("#ccomment-edit-action-save"),M.click(function(){E=L.attr("data-commentid"),E>0&&(h(L,E),z(M,L.val()))}),a("#ccomment-edit-action-cancel").click(function(){E>0&&(u(),v())}),L.keyup(function(){z(M,L.val())}),P.delegate('a[id^="ccomment-post-action-delete-"]',"click",function(b){b.preventDefault(),k(a(this))}),P.delegate('a[id^="ccomment-post-action-edit-"]',"click",function(b){b.preventDefault(),t(a(this))}),P.delegate('a[id^="ccomment-reply-"]',"click",function(b){b.preventDefault(),p(a(this))})}function B(){N=a("#ccomment-reply-textarea"),O=a("#ccomment-reply-action-save"),O.click(function(){i(N,G),z(O,N.val())}),a("#ccomment-reply-action-cancel").click(function(){r(),s()}),N.keyup(function(){z(O,N.val())}),P.delegate('a[id^="ccomment-reply-action-delete-"]',"click",function(b){b.preventDefault(),m(a(this))}),P.delegate('a[id^="ccomment-reply-action-edit-"]',"click",function(b){b.preventDefault(),q(a(this))})}var C=-1,D=null,E=0,F=0,G=0,H=-1,I=0,J=null,K=null,L=null,M=null,N=null,O=null,P=null;return{init:function(b){D=b,P=a("#ccomment-comments-content"),A(),B(),a(".block_socialcomments").delegate('input[id^="ccomment-pinned-"]',"click",function(){n(a(this))}),a("#ccomment-comments-subscribed").click(function(){o(a(this))}),P.delegate('a[id^="action-menu-toggle-"]',"click",function(b){b.preventDefault(),x(a(this))}),P.delegate('a[id^="ccomment-pagelink-"]',"click",function(b){b.preventDefault(),w(a(this))}),a(window).click(function(){y()})}}});